# Latest OpenSSH RPM / SRPM for old CentOS

For some reason I have to maintain OpenSSH up to date for CentOS which no longer have offical supports.

- CentOS 5
- CentOS 6
- CentOS 7
- Amazon Linux 1
- Amazon Linux 2
- Amazon Linux 2023

## Current Version:

- OpenSSH 9.6p1
- OpenSSL 3.0.8 (FIPS validated, see: [[OpenSSL Official](https://www.openssl.org/source/))

The build script reads `version.env` for actual version definitions.

## Build Requirements:

```bash
yum groupinstall -y "Development Tools"
yum install -y imake rpm-build pam-devel krb5-devel zlib-devel libXt-devel libX11-devel gtk2-devel perl-IPC-Cmd
```

### Note for CentOS 5:

- [Perl 5.10+](http://www.cpan.org/src/) is needed during build (`./configure.gnu && make && make install`)
- `gcc44` is prefered (`yum install gcc44`)

## Usage

```bash
# 1. Install build requirements as listed above.
# 2. Edit version.env file if you want a specific version of openssh/openssl combination (or maybe I havn't updated to the latest).

# 3. Download source packages.
# if any error comes up, just manally download the source tar files into the `downloads` dir.
./pullsrc.sh

# 4. Run the script to build RPMs. 
./compile.sh
# For CentOS 5, the default rpmbuild didn't set the variable of `${dist}`, manually run the script with argument `./compile.sh el5`
```

## Security

For **OLD** systems that are still on production, TOP security is hardly our first concern, while compatibility is.

This package provede the following options in `/etc/ssh/sshd_config` to work like the triditional sshd.

```
PubkeyAcceptedAlgorithms +ssh-rsa
UsePAM yes
PermitRootLogin yes
UseDNS no
```

## How to install

```bash
# Backup current SSH config
if test -e /etc/ssh/sshd_config; then
  mv /etc/ssh/sshd_config /etc/ssh/sshd_config.$(date +%Y%m%d)
fi

# Force install compiled packages.
yum install -y coreutils
OS_DIST="$(rpm --eval '%{?dist}'|tr -d '.')"
[ -z "$OS_DIST" ] && OS_DIST="el5"
BASE_PATH="$PWD/$OS_DIST/RPMS/$(uname -m)"

rpm -ivh --force --nodeps $BASE_PATH/openssh-9.6p1-1.$OS_DIST.x86_64.rpm
rpm -ivh --force --nodeps $BASE_PATH/openssh-clients-9.6p1-1.$OS_DIST.x86_64.rpm
rpm -ivh --force --nodeps $BASE_PATH/openssh-server-9.6p1-1.$OS_DIST.x86_64.rpm

# Backup origianl service file
if test -e /usr/lib/systemd/system/sshd.service; then
  mv /usr/lib/systemd/system/sshd.service /usr/lib/systemd/system/sshd.service.$(date +%Y%m%d)
fi
# Reload startup service file
if command -v systemctl >/dev/null 2>&1; then
  systemctl daemon-reload
  # Copy the config generated by system
  cp /run/systemd/generator.late/sshd.service /usr/lib/systemd/system/sshd.service 
fi
# Change default permissions
chmod 0600 /etc/ssh/ssh_host_*_key
# Restart service
service sshd restart
```

## Wanna üê≥Docker?

### Create image

#### Login registry

```shell
# Login info
USERNAME='User'
PASSWORD='Pa$$W0rd'
# Registry URL, leave it blank will use docker offcial registry: registry-1.docker.io
SERVER='harbor.example.com'

docker login -u "$USERNAME" -p "$PASSWORD" "$SERVER"

# Define the path of compenent
COMPONENT="$SERVER/cloudteam/openssh-rpm-builder"
```

#### CentOS

##### Build images

```shell
# Specify build versions
VERSIONS=("7" "6" "5")
# Define whether to enable Tsinghua University mirror source. (Very useful for Chinese users)
CHINA_MIRROR=0  # Setting this variable to non-zero means enabling

for VERSION in "${VERSIONS[@]}"
do
  echo "Building version: ${VERSION}"
  # Build docker image
  docker build \
         -t $COMPONENT:centos$VERSION \
         --build-arg VERSION_NUM=$VERSION \
         --build-arg CHINA_MIRROR=$CHINA_MIRROR \
         -f docker/Dockerfile.centos .
done

echo 'The building has been completed!'
```

##### Push images

```shell
  # Specify build versions
  VERSIONS=("7" "6" "5")

  for VERSION in "${VERSIONS[@]}"
  do
    echo "Pushing version: ${VERSION}"
    # Tag image
    docker tag $COMPONENT:centos$VERSION $COMPONENT:centos.$VERSION
    docker tag $COMPONENT:centos$VERSION $COMPONENT:centos.$VERSION.$(date +%Y%m%d)
    docker tag $COMPONENT:centos$VERSION $COMPONENT:el$VERSION
    # Push image
    docker push $COMPONENT:centos$VERSION
    docker push $COMPONENT:centos.$VERSION
    docker push $COMPONENT:centos.$VERSION.$(date +%Y%m%d)
    docker push $COMPONENT:el$VERSION
  done
  echo 'Push has been completed!'
```

#### Amazon Linux

##### Build images

```shell
# Specify build versions
VERSIONS=("2023" "2" "1")
# Define whether to enable China mirror source. (Very useful for Chinese users)
CHINA_MIRROR=0  # Setting this variable to non-zero means enabling

for VERSION in "${VERSIONS[@]}"
do
  echo "Building version: ${VERSION}"
  # Build docker image
  docker build \
         -t $COMPONENT:amazonlinux$VERSION \
         --build-arg VERSION_NUM=$VERSION \
         --build-arg CHINA_MIRROR=$CHINA_MIRROR \
         -f docker/Dockerfile.amazonlinux .
done
echo 'The building has been completed!'
```

##### Push images

```shell
# Specify build versions
VERSIONS=("2023" "2" "1")

for VERSION in "${VERSIONS[@]}"
do
  echo "Pushing version: ${VERSION}"
  # Tag image
  docker tag $COMPONENT:amazonlinux$VERSION $COMPONENT:amazonlinux.$VERSION
  docker tag $COMPONENT:amazonlinux$VERSION $COMPONENT:amazonlinux.$VERSION.$(date +%Y%m%d)
  docker tag $COMPONENT:amazonlinux$VERSION $COMPONENT:amzn$VERSION
  docker tag $COMPONENT:amazonlinux$VERSION $COMPONENT:al$VERSION
  # Push image
  docker push $COMPONENT:amazonlinux$VERSION
  docker push $COMPONENT:amazonlinux.$VERSION
  docker push $COMPONENT:amazonlinux.$VERSION.$(date +%Y%m%d)
  docker push $COMPONENT:amzn$VERSION
  docker push $COMPONENT:al$VERSION
done
echo 'Push has been completed!'
```

### Use image

#### Single OS

```shell
# Specify the name of tag.
IMAGE_TAG="amzn2023"
# Specify output path
OUT_PATH="$PWD"

mkdir -p $OUT_PATH

# Start container
docker run -it --rm \
       -v $OUT_PATH:/data/$IMAGE_TAG/RPMS \
       $COMPONENT:$IMAGE_TAG
```

#### Multi OS

```shell
# Specify output path
OUT_PATH="$PWD"

# Specify the name of tags.
IMAGE_TAGS=("amzn2023" "amzn2" "amzn1" "el7" "el6" "el5")

for IMAGE_TAG in "${IMAGE_TAGS[@]}"
do
  # Start container
  docker run -it --rm \
         -v $OUT_PATH:/data/$IMAGE_TAG/RPMS \
         $COMPONENT:$IMAGE_TAG
done
```
